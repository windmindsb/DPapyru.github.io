<!DOCTYPE html>
<!-- 泰拉瑞亚Mod制作教程文档查看器页面 -->
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档查看器 - 泰拉瑞亚Mod制作教程</title>
    <!-- 加载CSS样式文件 -->
    <link rel="stylesheet" href="../assets/css/style.css"> <!-- 主样式文件 -->
    <link rel="stylesheet" href="../assets/css/prism.min.css"> <!-- 代码高亮样式 -->
    <link rel="stylesheet" href="../assets/css/vs2022-theme.css"> <!-- VS2022代码高亮主题 -->
    <link rel="icon" type="image/png" href="../assets/imgs/Green_tModLoader.png"> <!-- 网站图标 -->

    <!-- 主题切换脚本 - 早期加载以避免闪烁 -->
    <script>
        // 主题切换早期加载脚本 - 防止页面加载时主题闪烁
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>

<body>
    <!-- 网站头部导航区域 -->
    <header class="site-header">
        <div class="container">
            <!-- 头部内容容器：包含网站logo、导航菜单和移动端菜单按钮 -->
            <div class="header-content">
                <!-- 网站logo和标题 -->
                <div class="logo">
                    <a href="../index.html">
                        <img src="../assets/imgs/Green_tModLoader.png" alt="泰拉瑞亚Mod制作教程" class="logo-image">
                        <h1 class="site-title">泰拉瑞亚Mod制作教程</h1>
                    </a>
                </div>
                <!-- 主导航菜单 -->
                <nav class="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../index.html" class="nav-link">首页</a></li>
                        <li class="nav-item"><a href="../docs/" class="nav-link active">文档</a></li>
                        <li class="nav-item"><a href="https://github.com/DPapyru/DPapyru.github.io" class="nav-link"
                                target="_blank">GitHub</a></li>
                    </ul>
                </nav>
                <!-- 移动端菜单切换按钮 -->
                <button class="mobile-menu-toggle" aria-label="切换菜单">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
                <!-- 手机端文档导航按钮 -->
                <button class="mobile-nav-toggle" id="mobile-nav-toggle" aria-label="文档导航">
                    <span class="nav-icon">☰</span>
                    <span class="nav-text">导航</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 网站主体容器：包含侧边栏和主内容区 -->
    <div class="site-container">
        <!-- 左侧边栏：文档导航和相关链接 -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- 侧边栏第一部分：文档导航 -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">文档导航</h3>
                    <ul class="sidebar-list" id="category-sidebar">
                        <!-- 分类侧边栏将通过JavaScript动态生成 -->
                    </ul>
                </div>
                <!-- 侧边栏第二部分：当前分类文档 -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title" id="current-category-title">当前分类</h3>
                    <ul class="sidebar-list" id="current-category-docs">
                        <!-- 当前分类的文档列表将通过JavaScript动态生成 -->
                    </ul>
                </div>
                <!-- 侧边栏第三部分：贡献者信息 -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">贡献者</h3>
                    <div class="contributors">
                        <p>欢迎参与贡献！</p>
                        <a href="../CONTRIBUTING.md" class="btn btn-small">如何贡献</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区域：显示Markdown文档内容 -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- 教程头部区域：包含面包屑导航和文档元信息 -->
                <div class="tutorial-header">
                    <!-- 面包屑导航 -->
                    <div class="breadcrumb">
                        <a href="../index.html">首页</a> &gt;
                        <a href="../docs/">文档</a> &gt;
                        <span class="current" id="current-doc-name">文档</span>
                    </div>
                    <!-- 文档标题 -->
                    <h1 class="tutorial-title" id="doc-title">文档</h1>
                    <!-- 文档元信息：难度、时间、作者、更新日期 -->
                    <div class="tutorial-meta" id="doc-meta">
                        <span class="difficulty">难度: <span class="difficulty-badge" id="doc-difficulty">未知</span></span>
                        <span class="time">预计时间: <span id="doc-time">未知</span></span>
                        <span class="author">作者: <span id="doc-author">未知</span></span>
                        <span class="date">更新日期: <span id="doc-date">未知</span></span>
                    </div>
                </div>

                <!-- 教程内容区域：加载和显示Markdown内容 -->
                <div class="tutorial-content">
                    <!-- 加载状态指示器：显示内容加载中的提示 -->
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="loading-spinner"></div>
                        <p>正在加载内容...</p>
                    </div>

                    <!-- 错误信息容器：当内容加载失败时显示错误信息 -->
                    <div id="error-message" class="error-message" style="display: none;">
                        <h3>加载失败</h3>
                        <p id="error-text">无法加载文档内容，请稍后再试。</p>
                    </div>

                    <!-- 目录容器：自动生成的文档目录 -->
                    <div id="table-of-contents" class="table-of-contents" style="display: none;">
                        <h3>目录</h3>
                        <ul id="toc-list"></ul>
                    </div>

                    <!-- Markdown内容容器：渲染后的HTML内容将插入这里 -->
                    <div id="markdown-content" class="markdown-content" style="display: none;">
                        <!-- 文档内容将通过Markdown渲染后插入这里 -->
                    </div>
                </div>

                <!-- 教程底部区域：导航链接和反馈表单 -->
                <div class="tutorial-footer">
                    <!-- 教程导航：上一篇/下一篇链接 -->
                    <div class="tutorial-navigation">
                        <a href="../docs/" class="btn btn-outline prev-tutorial">← 返回文档列表</a>
                        <a href="?file=test.md" class="btn btn-secondary">测试文档</a>
                        <a href="?file=02-基础概念/basic-concepts.md" class="btn btn-primary next-tutorial">基础教程 →</a>
                    </div>
                    <!-- 教程反馈：用户反馈和问题提交 -->
                    <div class="tutorial-feedback">
                        <h3>教程反馈</h3>
                        <p>如果你对本教程有任何问题或建议，欢迎在GitHub上提出Issue或PR。</p>
                        <a href="https://github.com/DPapyru/DPapyru.github.io/issues" class="btn btn-small"
                            target="_blank">提供反馈</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 网站底部区域 -->
    <footer class="site-footer">
        <div class="container">
            <!-- 底部内容容器 -->
            <div class="footer-content">
                <!-- 底部第一栏：关于项目 -->
                <div class="footer-section">
                    <h4>关于项目</h4>
                    <p>这是一个面向泰拉瑞亚Mod开发者的协作教程项目，旨在降低Mod制作门槛。</p>
                </div>
                <!-- 底部第二栏：快速链接 -->
                <div class="footer-section">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="../index.html">首页</a></li>
                        <li><a href="../docs/">文档</a></li>
                        <li><a href="https://github.com/DPapyru/DPapyru.github.io" target="_blank">GitHub</a></li>
                    </ul>
                </div>
                <!-- 底部第三栏：联系我们 -->
                <div class="footer-section">
                    <h4>联系我们</h4>
                    <ul>
                        <li><a href="https://github.com/DPapyru/DPapyru.github.io" target="_blank">GitHub</a></li>
                        <li><a href="mailto:contact@example.com">邮箱</a></li>
                    </ul>
                </div>
            </div>
            <!-- 底部版权信息 -->
            <div class="footer-bottom">
                <p>&copy; 2023 泰拉瑞亚Mod制作教程. 采用 <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC
                        BY 4.0</a> 许可协议。</p>
            </div>
        </div>
    </footer>

    <!-- 手机端导航覆盖层 -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay">
        <!-- 导航区域 (占屏幕2/3) -->
        <div class="mobile-nav-content">
            <div class="mobile-nav-header">
                <h3>文档导航</h3>
                <button class="mobile-nav-close" id="mobile-nav-close">✕</button>
            </div>
            <div class="mobile-nav-body">
                <!-- 导航内容将在这里动态生成 -->
                <div class="mobile-nav-sections" id="mobile-nav-sections">
                    <!-- 分类导航将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        <!-- 半透明返回区域 (占屏幕1/3) -->
        <div class="mobile-nav-back" id="mobile-nav-back">
            <div class="mobile-nav-back-hint">
                <p>点击此处返回文章</p>
                <div class="back-arrow">↑</div>
            </div>
        </div>
    </div>

    <!-- 加载JavaScript文件 -->
    <script src="../assets/js/theme-toggle.js"></script> <!-- 主题切换功能脚本 -->
    <script src="../assets/js/marked.min.js"></script> <!-- Markdown解析库 -->
    <script src="../assets/js/prism.min.js"></script> <!-- 代码高亮库 -->
    <script src="../assets/js/prism-csharp.min.js"></script> <!-- C#语言高亮支持 -->
    <script>
        // 设置一个标志，告诉main.js这是viewer.html页面，不要执行自动加载
        window.IS_VIEWER_PAGE = true;

        // 禁用main.js中的路由系统，避免干扰viewer.html的文件加载
        window.DISABLE_ROUTER = true;
    </script>
    <script src="../assets/js/main.js"></script> <!-- 主要功能脚本 -->
    <script src="../assets/js/navigation.js"></script> <!-- 导航功能脚本 -->

    <script>
        // 文档配置和元数据管理
        let DOC_CONFIG = null;
        let ALL_DOCS = [];

        // 主分类配置 - 与配置文件中的分类系统匹配
        const MAIN_CATEGORIES = {
            // 当前项目使用的分类系统
            '入门': {
                title: '入门',
                description: '适合初学者的基础教程',
                order: 1
            },
            '进阶': {
                title: '进阶',
                description: '有一定基础后的进阶教程',
                order: 2
            },
            '高级': {
                title: '高级',
                description: '面向有经验开发者的高级教程',
                order: 3
            },
            '个人分享': {
                title: '个人分享',
                description: '社区成员的个人经验和技巧分享',
                order: 4
            },
            '怎么贡献': {
                title: '怎么贡献',
                description: '介绍贡献者应该怎么贡献文章',
                order: 5
            },
            // 兼容外部项目的旧分类系统
            '0-开始': {
                title: '开始',
                description: '适合初学者的基础教程',
                order: 1,
                mapsTo: '入门' // 映射到当前分类系统
            },
            '1-基础': {
                title: '基础',
                description: '有一定基础后的进阶教程',
                order: 2,
                mapsTo: '入门' // 映射到当前分类系统
            },
            '2-中阶': {
                title: '中阶',
                description: '面向有经验开发者的高级教程',
                order: 3,
                mapsTo: '进阶' // 映射到当前分类系统
            },
            '3-高阶': {
                title: '高阶',
                description: '高级开发技巧和优化',
                order: 4,
                mapsTo: '高级' // 映射到当前分类系统
            },
            '4-专家': {
                title: '专家',
                description: '专家级开发技巧',
                order: 5,
                mapsTo: '高级' // 映射到当前分类系统
            }
        };

        // 主题领域配置
        const TOPIC_AREAS = {
            'env': {
                title: '环境配置',
                description: '开发环境搭建和配置'
            },
            'mod-basics': {
                title: 'Mod基础',
                description: 'Mod开发的基础概念和核心API'
            },
            'items': {
                title: '物品系统',
                description: '物品、武器和装备的开发'
            },
            'npcs': {
                title: 'NPC系统',
                description: 'NPC的创建和行为定制'
            },
            'world-gen': {
                title: '世界生成',
                description: '世界生成和地形修改'
            },
            'ui': {
                title: 'UI界面',
                description: '用户界面和交互设计'
            },
            'networking': {
                title: '网络功能',
                description: '多人游戏和网络通信'
            },
            'advanced': {
                title: '高级功能',
                description: '高级开发技巧和优化'
            }
        };

        // 旧路径重定向映射
        const OLD_PATH_REDIRECTS = {
            '01-入门指南/README.md': 'test.md',
            '02-基础概念/basic-concepts.md': 'test.md',
            '03-内容创建/content-creation.md': 'test.md',
            '04-高级开发/advanced-development.md': 'test.md',
            '05-专题主题/special-topics.md': 'test.md',
            '06-资源参考/resource-reference.md': 'test.md'
        };

        // 文档查看器的主要JavaScript逻辑
        document.addEventListener('DOMContentLoaded', function () {
            console.log('=== docs/viewer.html: 页面加载完成 ===');
            console.log('=== 诊断信息 ===');
            console.log('当前页面URL:', window.location.href);
            console.log('当前页面路径:', window.location.pathname);
            console.log('当前搜索参数:', window.location.search);

            // 初始化主题切换功能
            const themeToggle = new ThemeToggle({
                targetSelector: '.main-nav .nav-list',
                position: 'last' // 作为导航菜单的最后一项
            });
            themeToggle.init();

            // 初始化侧边栏滚动功能
            initializeSidebarScrolling();

            // 初始化文档配置
            initializeDocumentConfig().then(() => {
                // 初始化分类导航
                initializeCategoryNavigation();

                // 从URL参数获取要加载的Markdown文件
                const urlParams = new URLSearchParams(window.location.search);
                let markdownFile = urlParams.get('file');
                console.log('从URL参数获取的文件名:', markdownFile);

                // 如果没有指定文件，尝试从路径中获取
                if (!markdownFile) {
                    const pathParts = window.location.pathname.split('/');
                    markdownFile = pathParts[pathParts.length - 1];
                    console.log('从路径获取的文件名:', markdownFile);
                }

                // 如果还是没有，默认加载test.md
                if (!markdownFile || !markdownFile.endsWith('.md')) {
                    markdownFile = 'test.md';
                    console.log('使用默认文件名:', markdownFile);
                }

                console.log(`docs/viewer.html: 准备加载Markdown文件: ${markdownFile}`);

                // 延迟加载，确保所有脚本都已初始化
                setTimeout(function () {
                    // 直接使用本地加载函数，避免main.js中的路径处理问题
                    console.log('docs/viewer.html: 使用本地loadMarkdownDirectly函数');
                    loadMarkdownDirectly(markdownFile);
                }, 200);
            });

            // 初始化下拉菜单
            initializeDropdownMenu();

            // 初始化手机端导航
            initializeMobileNavigation();

            // 初始化MD渲染器
            initializeMarkedRender();
        });

        async function initializeMarkedRender() {
            console.log('初始化MD渲染器...');

            try {
                // 配置 marked.js 选项
                marked.use({
                    highlight: function (code, lang) {
                        if (typeof Prism !== 'undefined' && Prism.languages[lang]) {
                            return Prism.highlight(code, Prism.languages[lang], lang);
                        }
                        return code;
                    },
                    breaks: true,
                    gfm: true,
                    tables: true,
                    sanitize: false,
                    smartLists: true,
                    smartypants: true,
                    mangle: true,
                    headerIds: true,
                    xhtml: false,
                    pedantic: false
                });
                console.log('MD渲染器初始化完毕!');
            } catch (error) {
                console.error('初始化MD渲染器失败:', error);
            }
        }

        // 初始化文档配置
        async function initializeDocumentConfig() {
            try {
                // 尝试加载配置文件
                const configResponse = await fetch('./config.json');
                if (configResponse.ok) {
                    DOC_CONFIG = await configResponse.json();
                    console.log('成功加载配置文件:', DOC_CONFIG);
                } else {
                    console.warn('配置文件不存在，使用默认配置');
                    DOC_CONFIG = generateDefaultConfig();
                }
            } catch (error) {
                console.warn('加载配置文件失败，使用默认配置:', error);
                DOC_CONFIG = generateDefaultConfig();
            }

            // 扫描所有文档文件
            await scanAllDocuments();
        }

        // 生成默认配置（当config.json不存在时）
        function generateDefaultConfig() {
            const config = {
                categories: {},
                topics: {},
                authors: {},
                all_files: []
            };

            // 初始化分类结构
            Object.keys(MAIN_CATEGORIES).forEach(categoryKey => {
                config.categories[categoryKey] = {
                    title: MAIN_CATEGORIES[categoryKey].title,
                    description: MAIN_CATEGORIES[categoryKey].description,
                    topics: {}
                };
            });

            // 初始化主题结构
            Object.keys(TOPIC_AREAS).forEach(topicKey => {
                config.topics[topicKey] = {
                    title: TOPIC_AREAS[topicKey].title,
                    description: TOPIC_AREAS[topicKey].description
                };
            });

            return config;
        }

        // 扫描所有文档文件
        async function scanAllDocuments() {
            console.log('=== scanAllDocuments() 诊断开始 ===');
            try {
                // 完全依赖配置文件，因为git上传后会调用generate-index.js生成新的config.json
                try {
                    const configResponse = await fetch('./config.json');
                    if (configResponse.ok) {
                        const config = await configResponse.json();
                        console.log('成功加载配置文件:', config);

                        // 从配置文件中提取文档列表
                        ALL_DOCS = config.all_files || [];
                        console.log('从配置文件加载的文档数量:', ALL_DOCS.length);
                        console.log('从配置文件加载的文档:', ALL_DOCS);

                        // 如果配置文件中有文档，直接使用
                        if (ALL_DOCS.length > 0) {
                            // 确保每个文档都有必要的属性
                            ALL_DOCS = ALL_DOCS.map(doc => {
                                // 处理分类映射
                                let category = doc.category || '入门';
                                if (category && MAIN_CATEGORIES[category] && MAIN_CATEGORIES[category].mapsTo) {
                                    const oldCategory = category;
                                    category = MAIN_CATEGORIES[category].mapsTo;
                                    console.log(`文档 ${doc.title} 的分类从 ${oldCategory} 映射到 ${category}`);
                                }

                                // 处理标签格式
                                let tags = [];
                                if (doc.tags) {
                                    if (Array.isArray(doc.tags)) {
                                        tags = doc.tags;
                                    } else if (typeof doc.tags === 'string') {
                                        // 处理可能的JSON字符串格式
                                        try {
                                            const parsedTags = JSON.parse(doc.tags);
                                            tags = Array.isArray(parsedTags) ? parsedTags : [parsedTags];
                                        } catch (e) {
                                            // 如果不是JSON，按逗号分割
                                            tags = doc.tags.split(',').map(t => t.trim());
                                        }
                                    }
                                }

                                return {
                                    ...doc,
                                    title: doc.title || doc.filename.replace('.md', ''),
                                    author: doc.author || '未知',
                                    category: category,
                                    topic: doc.topic || 'mod-basics',
                                    order: parseInt(doc.order) || 999,
                                    description: doc.description || '',
                                    tags: tags,
                                    last_updated: doc.last_updated || '未知'
                                };
                            });

                            console.log('处理后的文档列表:', ALL_DOCS);
                            console.log('=== scanAllDocuments() 诊断结束 ===');
                            return;
                        } else {
                            console.warn('配置文件中没有找到文档');
                        }
                    } else {
                        console.warn(`配置文件请求失败: ${configResponse.status} ${configResponse.statusText}`);
                    }
                } catch (configError) {
                    console.warn('加载配置文件失败:', configError);
                }

                // 如果配置文件加载失败或没有文档，尝试扫描常见的文档文件
                console.log('配置文件不可用，尝试扫描常见文档文件');
                const commonFiles = [
                    'DPapyru-给新人的前言.md',
                    'DPapyru-ForContributors-Basic.md',
                    'TopicSystemGuide.md',
                    'tutorial-index.md',
                    'test.md'
                ];

                ALL_DOCS = [];

                for (const filename of commonFiles) {
                    try {
                        console.log(`尝试处理文档: ${filename}`);
                        // 获取文档内容和元数据
                        const docUrl = `./${filename}`;
                        const docResponse = await fetch(docUrl);

                        if (docResponse.ok) {
                            const content = await docResponse.text();
                            const { metadata } = parseFrontMatter(content);

                            // 处理分类映射
                            let category = metadata.category || '入门';
                            if (category && MAIN_CATEGORIES[category] && MAIN_CATEGORIES[category].mapsTo) {
                                const oldCategory = category;
                                category = MAIN_CATEGORIES[category].mapsTo;
                                console.log(`文档 ${filename} 的分类从 ${oldCategory} 映射到 ${category}`);
                            }

                            const docInfo = {
                                filename: filename,
                                title: metadata.title || filename.replace('.md', ''),
                                author: metadata.author || '未知',
                                category: category,
                                topic: metadata.topic || 'mod-basics',
                                order: parseInt(metadata.order) || 999,
                                description: metadata.description || '',
                                tags: metadata.tags ? metadata.tags.split(',').map(t => t.trim()) : [],
                                last_updated: metadata.last_updated || '未知'
                            };

                            ALL_DOCS.push(docInfo);
                            console.log('成功添加文档:', docInfo.title);
                        } else {
                            console.warn(`文档 ${filename} 请求失败: ${docResponse.status} ${docResponse.statusText}`);
                        }
                    } catch (error) {
                        console.warn(`无法处理文档 ${filename}:`, error);
                    }
                }

                // 按分类和排序
                ALL_DOCS.sort((a, b) => {
                    if (a.category !== b.category) {
                        return (MAIN_CATEGORIES[a.category]?.order || 999) - (MAIN_CATEGORIES[b.category]?.order || 999);
                    }
                    return a.order - b.order;
                });

                console.log('扫描到的文档数量:', ALL_DOCS.length);
                console.log('扫描到的文档:', ALL_DOCS);
                console.log('=== scanAllDocuments() 诊断结束 ===');

            } catch (error) {
                console.error('扫描文档失败:', error);
                console.log('=== scanAllDocuments() 因错误结束 ===');
                // 提供一些默认文档
                ALL_DOCS = [
                    {
                        filename: 'test.md',
                        title: '测试文档',
                        author: '测试',
                        category: '入门',
                        topic: 'mod-basics',
                        order: 1,
                        description: '用于测试文档查看器功能的示例文档',
                        tags: ['测试'],
                        last_updated: '2025-11-26'
                    }
                ];
                console.log('使用默认文档配置');
            }
        }

        // 使用文档信息更新配置
        function updateConfigWithDocument(docInfo) {
            const { category, topic } = docInfo;

            // 确保分类存在
            if (!DOC_CONFIG.categories[category]) {
                DOC_CONFIG.categories[category] = {
                    title: category,
                    description: `${category}相关文档`,
                    topics: {}
                };
            }

            // 确保主题存在
            if (!DOC_CONFIG.categories[category].topics[topic]) {
                DOC_CONFIG.categories[category].topics[topic] = {
                    title: TOPIC_AREAS[topic]?.title || topic,
                    description: TOPIC_AREAS[topic]?.description || '',
                    files: []
                };
            }

            // 添加文件到对应主题
            DOC_CONFIG.categories[category].topics[topic].files.push(docInfo);

            // 更新作者信息
            if (!DOC_CONFIG.authors[docInfo.author]) {
                DOC_CONFIG.authors[docInfo.author] = {
                    name: docInfo.author,
                    files: []
                };
            }
            DOC_CONFIG.authors[docInfo.author].files.push(docInfo.filename);

            // 添加到所有文件列表
            DOC_CONFIG.all_files.push(docInfo);
        }
        // 直接加载Markdown内容的备用函数
        function loadMarkdownDirectly(filePath) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const markdownContent = document.getElementById('markdown-content');

            console.log(`=== loadMarkdownDirectly() 诊断开始 ===`);
            console.log(`docs/viewer.html: 原始文件路径: ${filePath}`);
            console.log('当前页面位置:', window.location.href);

            // 增强的路径清理逻辑
            let fetchPath = filePath;
            console.log(`docs/viewer.html: 初始fetchPath: ${fetchPath}`);

            // 1. URL解码
            fetchPath = decodeURIComponent(fetchPath);
            console.log(`docs/viewer.html: URL解码后: ${fetchPath}`);

            // 2. 如果只是文件名，尝试在文档列表中查找完整路径
            if (!fetchPath.includes('/') && ALL_DOCS.length > 0) {
                const doc = ALL_DOCS.find(d => d.filename === fetchPath || d.path === fetchPath);
                if (doc && doc.path) {
                    fetchPath = doc.path;
                    console.log(`docs/viewer.html: 通过文档列表找到完整路径: ${fetchPath}`);
                }
            }

            // 3. 移除开头的docs/前缀（因为viewer.html已经在docs目录中）
            if (fetchPath.startsWith('docs/')) {
                fetchPath = fetchPath.substring(5);
                console.log(`docs/viewer.html: 移除docs前缀: ${fetchPath}`);
            }

            // 4. 移除开头的斜杠
            if (fetchPath.startsWith('/')) {
                fetchPath = fetchPath.substring(1);
                console.log(`docs/viewer.html: 移除开头斜杠: ${fetchPath}`);
            }

            // 4. 检查是否是旧路径格式，进行重定向
            if (OLD_PATH_REDIRECTS[fetchPath]) {
                fetchPath = OLD_PATH_REDIRECTS[fetchPath];
                console.log(`docs/viewer.html: 旧路径重定向: ${fetchPath}`);
            }

            // 5. 检查是否是已知的分类名或特殊文件
            const knownCategories = ['00-测试文档', '01-入门指南', '02-基础概念', '03-内容创建', '04-高级开发', '05-专题主题', '06-资源参考'];
            const rootFiles = ['test.md']; // 位于docs根目录的文件列表

            if (knownCategories.includes(fetchPath) || fetchPath.match(/^\d+-[^\/]+$/)) {
                // 如果是分类名，尝试重定向到对应的文档
                console.log(`docs/viewer.html: 识别为旧分类名，尝试重定向`);
                // 尝试找到该分类下的第一个文档
                const firstDoc = ALL_DOCS.find(doc => doc.category === getCategoryFromOldPath(fetchPath));
                if (firstDoc) {
                    fetchPath = firstDoc.filename;
                    console.log(`docs/viewer.html: 重定向到文档: ${fetchPath}`);
                } else {
                    // 如果找不到对应文档，使用默认文档
                    fetchPath = 'test.md';
                    console.log(`docs/viewer.html: 未找到对应文档，使用默认: ${fetchPath}`);
                }
            } else if (rootFiles.includes(fetchPath)) {
                // 如果是根目录下的特殊文件，直接使用
                console.log(`docs/viewer.html: 识别为根目录文件: ${fetchPath}`);
            } else if (fetchPath.includes('/')) {
                // 路径已经包含目录，检查是否是旧格式
                if (fetchPath.match(/^\d+-[^\/]+\/.*/)) {
                    // 旧格式路径，尝试重定向
                    console.log(`docs/viewer.html: 识别为旧格式路径，尝试重定向`);
                    const filename = fetchPath.split('/').pop();
                    const doc = ALL_DOCS.find(d => d.filename === filename || d.filename.endsWith(filename));
                    if (doc) {
                        fetchPath = doc.filename;
                        console.log(`docs/viewer.html: 重定向到文档: ${fetchPath}`);
                    } else {
                        // 如果找不到对应文档，使用默认文档
                        fetchPath = 'test.md';
                        console.log(`docs/viewer.html: 未找到对应文档，使用默认: ${fetchPath}`);
                    }
                } else {
                    // 路径已经包含目录，直接使用
                    console.log(`docs/viewer.html: 使用完整路径: ${fetchPath}`);
                }
            } else {
                // 如果只是文件名，检查是否存在于文档列表中
                const doc = ALL_DOCS.find(d => d.filename === fetchPath || d.path === fetchPath || d.filename === `${fetchPath}.md`);
                if (doc) {
                    fetchPath = doc.path || doc.filename;
                    console.log(`docs/viewer.html: 找到匹配文档: ${fetchPath}`);
                } else {
                    // 如果找不到，使用默认文档
                    fetchPath = 'test.md';
                    console.log(`docs/viewer.html: 未找到匹配文档，使用默认: ${fetchPath}`);
                }
            }

            // 6. 确保文件以.md结尾
            if (!fetchPath.endsWith('.md')) {
                fetchPath += '.md';
                console.log(`docs/viewer.html: 添加.md扩展名: ${fetchPath}`);
            }

            console.log(`docs/viewer.html: 最终使用路径: ${fetchPath}`);

            // 确保路径相对于当前页面（docs目录）
            let fetchUrl = fetchPath.startsWith('./') ? fetchPath : `./${fetchPath}`;

            // 避免重复的docs路径
            if (fetchUrl.startsWith('./docs/')) {
                fetchUrl = fetchUrl.substring(6); // 移除 './docs/'
                if (!fetchUrl.startsWith('./')) {
                    fetchUrl = `./${fetchUrl}`;
                }
            }

            console.log(`docs/viewer.html: 实际fetch URL: ${fetchUrl}`);
            console.log(`完整请求URL将是: ${window.location.origin}${window.location.pathname.replace(/\/[^\/]*$/, '/')}${fetchUrl}`);

            fetch(fetchUrl)
                .then(response => {
                    console.log(`获取响应状态: ${response.status} ${response.statusText}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(markdownText => {
                    console.log(`docs/viewer.html: 成功获取Markdown内容，长度: ${markdownText.length}`);

                    if (typeof marked !== 'undefined') {
                        console.log('marked.js已加载，开始渲染');

                        // 解析Front Matter（文档元数据）
                        const frontMatter = parseFrontMatter(markdownText);
                        const content = frontMatter.content;
                        const metadata = frontMatter.metadata;

                        console.log('解析的元数据:', metadata);

                        // 更新页面元数据（标题、难度、作者等）
                        updatePageMetadata(metadata, fetchPath);

                        // 更新当前分类的文档列表
                        updateCurrentCategoryDocs(fetchPath);

                        const renderedHTML = marked.parse(content);
                        console.log('Markdown渲染完成，HTML长度:', renderedHTML.length);
                        markdownContent.innerHTML = renderedHTML;

                        // 应用代码语法高亮
                        if (typeof Prism !== 'undefined') {
                            console.log('应用代码高亮');
                            Prism.highlightAllUnder(markdownContent);
                        } else {
                            console.warn('Prism.js未加载，跳过代码高亮');
                        }

                        // 自动生成文档目录
                        generateTableOfContents(markdownContent);

                        // 显示内容，隐藏加载指示器
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        markdownContent.style.display = 'block';
                        document.getElementById('table-of-contents').style.display = 'block';

                    } else {
                        throw new Error('marked.js未加载');
                    }
                })
                .catch(error => {
                    console.error('docs/viewer.html: 加载Markdown失败:', error);
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (errorMessage) {
                        errorMessage.style.display = 'block';
                        document.getElementById('error-text').textContent = `无法加载文件 "${fetchPath}": ${error.message}`;
                    }
                });
        }

        // 分类映射函数：将旧分类系统映射到新分类系统
        function mapCategoryToNewSystem(oldCategory) {
            console.log(`映射分类: ${oldCategory}`);

            // 如果分类已经存在于新系统中，直接返回
            if (MAIN_CATEGORIES[oldCategory] && !MAIN_CATEGORIES[oldCategory].mapsTo) {
                console.log(`分类 ${oldCategory} 已存在于新系统中`);
                return oldCategory;
            }

            // 如果分类有映射配置，使用映射
            if (MAIN_CATEGORIES[oldCategory] && MAIN_CATEGORIES[oldCategory].mapsTo) {
                const newCategory = MAIN_CATEGORIES[oldCategory].mapsTo;
                console.log(`分类 ${oldCategory} 映射到 ${newCategory}`);
                return newCategory;
            }

            // 尝试从旧路径中提取分类
            const pathMap = {
                '00-测试文档': '入门',
                '01-入门指南': '入门',
                '02-基础概念': '入门',
                '03-内容创建': '进阶',
                '04-高级开发': '高级',
                '05-专题主题': '高级',
                '06-资源参考': '个人分享',
                '0-开始': '入门',
                '1-基础': '入门',
                '2-中阶': '进阶',
                '3-高阶': '高级',
                '4-专家': '高级'
            };

            const mappedCategory = pathMap[oldCategory] || '入门';
            console.log(`通过路径映射，分类 ${oldCategory} 映射到 ${mappedCategory}`);
            return mappedCategory;
        }

        // 从旧路径获取对应的分类
        function getCategoryFromOldPath(oldPath) {
            console.log(`从旧路径获取分类: ${oldPath}`);
            const category = mapCategoryToNewSystem(oldPath);
            console.log(`映射结果: ${category}`);
            return category;
        }

        // 解析Front Matter（文档开头的元数据部分）
        function parseFrontMatter(text) {
            const frontMatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
            const match = text.match(frontMatterRegex);

            if (match) {
                const metadata = {};
                const metadataLines = match[1].split('\n');

                metadataLines.forEach(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const key = line.substring(0, colonIndex).trim();
                        const value = line.substring(colonIndex + 1).trim();
                        metadata[key] = value;
                    }
                });

                return {
                    metadata: metadata,
                    content: match[2]
                };
            }

            return {
                metadata: {},
                content: text
            };
        }

        // 更新页面元数据（标题、难度、时间、作者、日期）
        function updatePageMetadata(metadata, filePath) {
            const title = metadata.title || filePath.replace('.md', '');
            const difficulty = metadata.difficulty || 'beginner';
            const time = metadata.time || '未知';
            const author = metadata.author || '未知';
            const last_updated = metadata.last_updated || '未知';
            const prevChapter = metadata.prev_chapter || null;
            const nextChapter = metadata.next_chapter || null;

            console.log('更新页面元数据:', { title, difficulty, time, author, last_updated, prevChapter, nextChapter });

            document.title = `${title} - 泰拉瑞亚Mod制作教程`;
            document.getElementById('current-doc-name').textContent = title;
            document.getElementById('doc-title').textContent = title;
            document.getElementById('doc-difficulty').textContent = getDifficultyText(difficulty);
            document.getElementById('doc-difficulty').className = `difficulty-badge ${difficulty}`;
            document.getElementById('doc-time').textContent = time;
            document.getElementById('doc-author').textContent = author;
            document.getElementById('doc-date').textContent = last_updated;

            // 更新面包屑导航
            updateBreadcrumbNavigation(metadata, filePath);

            // 更新导航按钮
            updateNavigationButtons(prevChapter, nextChapter);
        }

        // 更新面包屑导航
        function updateBreadcrumbNavigation(metadata, filePath) {
            const breadcrumb = document.querySelector('.breadcrumb');
            if (!breadcrumb) return;

            // 查找当前文档信息
            const currentDoc = ALL_DOCS.find(doc => doc.filename === filePath || doc.path === filePath);

            // 清空现有面包屑
            breadcrumb.innerHTML = '';

            // 添加首页链接
            const homeLink = document.createElement('a');
            homeLink.href = '../index.html';
            homeLink.textContent = '首页';
            breadcrumb.appendChild(homeLink);

            // 添加分隔符
            const separator1 = document.createElement('span');
            separator1.className = 'breadcrumb-separator';
            separator1.textContent = ' > ';
            breadcrumb.appendChild(separator1);

            // 添加文档列表链接
            const docsLink = document.createElement('a');
            docsLink.href = '../docs/';
            docsLink.textContent = '文档';
            breadcrumb.appendChild(docsLink);

            // 如果找到当前文档信息，添加分类和主题路径
            if (currentDoc) {
                // 添加分隔符
                const separator2 = document.createElement('span');
                separator2.className = 'breadcrumb-separator';
                separator2.textContent = ' > ';
                breadcrumb.appendChild(separator2);

                // 添加分类链接
                const category = MAIN_CATEGORIES[currentDoc.category];
                if (category) {
                    const categoryLink = document.createElement('a');
                    categoryLink.href = `../docs/?category=${encodeURIComponent(currentDoc.category)}`;
                    categoryLink.textContent = category.title;
                    breadcrumb.appendChild(categoryLink);

                    // 添加分隔符
                    const separator3 = document.createElement('span');
                    separator3.className = 'breadcrumb-separator';
                    separator3.textContent = ' > ';
                    breadcrumb.appendChild(separator3);

                    // 如果有主题，添加主题链接
                    if (currentDoc.topic && DOC_CONFIG.topics && DOC_CONFIG.topics[currentDoc.topic]) {
                        const topic = DOC_CONFIG.topics[currentDoc.topic];
                        const topicLink = document.createElement('a');
                        topicLink.href = `../docs/?category=${encodeURIComponent(currentDoc.category)}&topic=${encodeURIComponent(currentDoc.topic)}`;
                        topicLink.textContent = topic.title;
                        breadcrumb.appendChild(topicLink);

                        // 添加分隔符
                        const separator4 = document.createElement('span');
                        separator4.className = 'breadcrumb-separator';
                        separator4.textContent = ' > ';
                        breadcrumb.appendChild(separator4);
                    }
                }
            }

            // 添加当前文档标题
            const currentSpan = document.createElement('span');
            currentSpan.className = 'current';
            currentSpan.textContent = metadata.title || filePath.replace('.md', '');
            breadcrumb.appendChild(currentSpan);
        }

        // 更新导航按钮
        function updateNavigationButtons(prevChapter, nextChapter) {
            const navigationContainer = document.querySelector('.tutorial-navigation');
            if (!navigationContainer) {
                console.warn('找不到导航容器');
                return;
            }

            // 清空现有导航内容
            navigationContainer.innerHTML = '';

            // 添加返回文档列表按钮
            const backToListBtn = document.createElement('a');
            backToListBtn.href = '../docs/';
            backToListBtn.className = 'btn btn-outline prev-tutorial';
            backToListBtn.textContent = '← 返回文档列表';
            navigationContainer.appendChild(backToListBtn);

            // 添加上一章按钮（如果存在）
            if (prevChapter) {
                const prevBtn = document.createElement('a');
                prevBtn.href = `?file=${prevChapter}`;
                prevBtn.className = 'btn btn-secondary prev-tutorial';
                prevBtn.textContent = '← 上一章';
                navigationContainer.appendChild(prevBtn);
            }

            // 添加下一章按钮（如果存在）
            if (nextChapter) {
                const nextBtn = document.createElement('a');
                nextBtn.href = `?file=${nextChapter}`;
                nextBtn.className = 'btn btn-primary next-tutorial';
                nextBtn.textContent = '下一章 →';
                navigationContainer.appendChild(nextBtn);
            }

            console.log('导航按钮已更新:', { prevChapter, nextChapter });
        }

        // 将难度代码转换为中文文本
        function getDifficultyText(difficulty) {
            const difficultyMap = {
                'beginner': '初级',
                'intermediate': '中级',
                'advanced': '高级'
            };
            return difficultyMap[difficulty] || difficulty;
        }

        // 生成文档目录（基于标题h1-h6）
        function generateTableOfContents(contentElement) {
            const tableOfContents = document.getElementById('table-of-contents');
            const tocList = document.getElementById('toc-list');

            if (!tableOfContents || !tocList || !contentElement) {
                return;
            }

            const headings = contentElement.querySelectorAll('h1, h2, h3, h4, h5, h6');
            console.log(`找到 ${headings.length} 个标题用于生成目录`);

            if (headings.length === 0) {
                tableOfContents.style.display = 'none';
                return;
            }

            tocList.innerHTML = '';

            headings.forEach((heading, index) => {
                // 为没有ID的标题自动生成ID
                if (!heading.id) {
                    heading.id = `heading-${index}`;
                }

                // 创建目录项
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${heading.id}`;
                a.textContent = heading.textContent;

                // 根据标题级别设置缩进
                const level = parseInt(heading.tagName.substring(1));
                a.style.paddingLeft = `${(level - 1) * 15}px`;

                li.appendChild(a);
                tocList.appendChild(li);

                // 添加平滑滚动效果
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetElement = document.getElementById(heading.id);
                    if (targetElement) {
                        // 计算滚动位置，考虑固定头部高度
                        const headerHeight = document.querySelector('.site-header').offsetHeight;
                        const targetPosition = targetElement.offsetTop - headerHeight - 20;

                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });

            tableOfContents.style.display = 'block';
            console.log('目录生成完成');
        }

        // 检查分类是否有文档
        function categoryHasDocuments(categoryKey) {
            console.log(`检查分类 ${categoryKey} 是否有文档`);

            // 首先检查ALL_DOCS中是否有该分类的文档
            if (ALL_DOCS && ALL_DOCS.length > 0) {
                const docsInCategory = ALL_DOCS.filter(doc => doc.category === categoryKey);
                if (docsInCategory.length > 0) {
                    console.log(`在ALL_DOCS中找到 ${docsInCategory.length} 个 ${categoryKey} 分类的文档`);
                    return true;
                }
            }

            // 如果ALL_DOCS中没有，检查配置文件
            if (!DOC_CONFIG || !DOC_CONFIG.categories || !DOC_CONFIG.categories[categoryKey]) {
                console.log(`配置文件中没有找到分类 ${categoryKey}`);
                return false;
            }

            const categoryTopics = DOC_CONFIG.categories[categoryKey].topics || {};
            console.log(`分类 ${categoryKey} 下的主题:`, Object.keys(categoryTopics));

            // 检查该分类下是否有任何主题包含文档
            for (const topicKey in categoryTopics) {
                const topic = categoryTopics[topicKey];
                if (topic.files && topic.files.length > 0) {
                    console.log(`主题 ${topicKey} 下有 ${topic.files.length} 个文档`);
                    return true;
                }
            }

            console.log(`分类 ${categoryKey} 没有找到任何文档`);
            return false;
        }

        // 初始化分类导航
        function initializeCategoryNavigation() {
            console.log('=== initializeCategoryNavigation() 开始 ===');
            const categorySidebar = document.getElementById('category-sidebar');

            if (!categorySidebar) {
                console.error('找不到分类侧边栏元素');
                return;
            }

            // 清空现有导航
            categorySidebar.innerHTML = '';

            // 等待配置加载完成
            if (!DOC_CONFIG) {
                console.warn('文档配置尚未加载，稍后重试');
                setTimeout(initializeCategoryNavigation, 100);
                return;
            }

            console.log('DOC_CONFIG已加载，开始生成分类导航');
            console.log('ALL_DOCS数量:', ALL_DOCS.length);
            console.log('可用分类:', Object.keys(MAIN_CATEGORIES));

            // 添加分割线
            const divider = document.createElement('div');
            divider.className = 'sidebar-divider';
            categorySidebar.appendChild(divider);

            // 生成分类导航
            let visibleCategories = 0;
            Object.keys(MAIN_CATEGORIES).forEach(categoryKey => {
                const category = MAIN_CATEGORIES[categoryKey];
                console.log(`处理分类: ${categoryKey} (${category.title})`);

                // 检查该分类是否有文档，如果没有则跳过
                if (!categoryHasDocuments(categoryKey)) {
                    console.log(`跳过空分类: ${categoryKey}`);
                    return; // 跳过空分类
                }

                visibleCategories++;
                console.log(`显示分类: ${categoryKey}`);

                // 创建分类导航项
                const categoryItem = document.createElement('li');
                categoryItem.className = 'category-item';

                // 创建分类标题
                const categoryHeader = document.createElement('h4');
                categoryHeader.className = 'category-header';

                // 添加分类标题文本
                const titleSpan = document.createElement('span');
                titleSpan.className = 'category-title-text';
                titleSpan.textContent = category.title;
                categoryHeader.appendChild(titleSpan);

                // 添加展开/收起按钮
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'category-toggle';
                toggleBtn.setAttribute('aria-label', '展开/收起分类');
                toggleBtn.innerHTML = '▼';
                categoryHeader.appendChild(toggleBtn);

                categoryItem.appendChild(categoryHeader);

                // 创建主题子菜单
                const topicList = document.createElement('ul');
                topicList.className = 'topic-list';

                // 获取该分类下的所有主题
                const categoryTopics = DOC_CONFIG.categories[categoryKey]?.topics || {};

                if (Object.keys(categoryTopics).length > 0) {
                    Object.keys(categoryTopics).forEach(topicKey => {
                        const topic = categoryTopics[topicKey];

                        // 检查主题是否有文档，如果没有则跳过
                        if (!topic.files || topic.files.length === 0) {
                            return; // 跳过空主题
                        }

                        // 创建主题标题
                        const topicHeader = document.createElement('h5');
                        topicHeader.className = 'topic-header';

                        // 添加主题标题文本
                        const topicTitleSpan = document.createElement('span');
                        topicTitleSpan.className = 'topic-title-text';
                        topicTitleSpan.textContent = topic.title;
                        topicHeader.appendChild(topicTitleSpan);

                        // 添加展开/收起按钮
                        const topicToggleBtn = document.createElement('button');
                        topicToggleBtn.className = 'topic-toggle';
                        topicToggleBtn.setAttribute('aria-label', '展开/收起主题');
                        topicToggleBtn.innerHTML = '▼';
                        topicHeader.appendChild(topicToggleBtn);

                        // 为主题标题添加点击事件
                        topicHeader.addEventListener('click', function () {
                            toggleTopic(categoryKey, topicKey, topicHeader, topicHeader.nextElementSibling);
                        });

                        // 为主题标题的按钮添加点击事件
                        topicToggleBtn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            toggleTopic(categoryKey, topicKey, topicHeader, topicHeader.nextElementSibling);
                        });

                        topicList.appendChild(topicHeader);

                        // 创建文档列表
                        const fileList = document.createElement('ul');
                        fileList.className = 'file-list';

                        // 确保topic.files存在且是数组
                        const files = topic.files || [];
                        files.forEach(file => {
                            const fileItem = document.createElement('li');
                            fileItem.className = 'file-item';

                            const fileLink = document.createElement('a');
                            fileLink.href = `?file=${file.path || file.filename}`;
                            fileLink.textContent = file.title;
                            fileLink.title = `${file.author || '未知'} - ${file.description || file.title}`;

                            fileItem.appendChild(fileLink);
                            fileList.appendChild(fileItem);
                        });

                        topicList.appendChild(fileList);
                    });
                }

                categoryItem.appendChild(topicList);
                categorySidebar.appendChild(categoryItem);

                // 为分类标题添加点击事件
                categoryHeader.addEventListener('click', function () {
                    toggleCategory(categoryKey, categoryHeader, topicList);
                });

                // 为分类标题的按钮添加点击事件
                toggleBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleCategory(categoryKey, categoryHeader, topicList);
                });

                // 恢复分类的展开/收起状态
                const isCollapsed = getCollapsedState('category', categoryKey);
                if (isCollapsed) {
                    topicList.classList.add('collapsed');
                    toggleBtn.classList.add('collapsed');
                    // toggleBtn.innerHTML = '▶';
                } else {
                    toggleBtn.innerHTML = '▼';
                }
            });

            // 添加分割线
            const allDocsDivider = document.createElement('div');
            allDocsDivider.className = 'sidebar-divider';
            categorySidebar.appendChild(allDocsDivider);

            // 添加"所有文档"部分
            const allDocsItem = document.createElement('li');
            allDocsItem.className = 'category-item all-docs';

            const allDocsHeader = document.createElement('h4');
            allDocsHeader.className = 'category-header';

            // 添加"所有文档"标题文本
            const allDocsTitleSpan = document.createElement('span');
            allDocsTitleSpan.className = 'category-title-text';
            allDocsTitleSpan.textContent = '所有文档';
            allDocsHeader.appendChild(allDocsTitleSpan);

            // 添加展开/收起按钮
            const allDocsToggleBtn = document.createElement('button');
            allDocsToggleBtn.className = 'category-toggle';
            allDocsToggleBtn.setAttribute('aria-label', '展开/收起所有文档');
            allDocsToggleBtn.innerHTML = '▼';
            allDocsHeader.appendChild(allDocsToggleBtn);

            allDocsItem.appendChild(allDocsHeader);

            const allDocsList = document.createElement('ul');
            allDocsList.className = 'file-list';

            // 确保ALL_DOCS存在且是数组
            const allDocs = ALL_DOCS || [];
            if (allDocs.length === 0) {
                // 如果没有文档，显示提示信息
                const noDocsItem = document.createElement('li');
                noDocsItem.className = 'no-docs';
                noDocsItem.textContent = '未找到任何文档';
                allDocsList.appendChild(noDocsItem);
            } else {
                // 按分类和排序组织文档
                const sortedDocs = [...allDocs].sort((a, b) => {
                    // 先按分类排序
                    const categoryOrderA = MAIN_CATEGORIES[a.category]?.order || 999;
                    const categoryOrderB = MAIN_CATEGORIES[b.category]?.order || 999;
                    if (categoryOrderA !== categoryOrderB) {
                        return categoryOrderA - categoryOrderB;
                    }
                    // 同一分类内按排序值排序
                    return (a.order || 999) - (b.order || 999);
                });

                sortedDocs.forEach(doc => {
                    const docItem = document.createElement('li');
                    docItem.className = 'file-item';

                    const docLink = document.createElement('a');
                    docLink.href = `?file=${doc.path || doc.filename}`;
                    docLink.textContent = doc.title;

                    // 添加更详细的标题信息
                    const categoryTitle = MAIN_CATEGORIES[doc.category]?.title || doc.category;
                    const topicTitle = DOC_CONFIG.topics[doc.topic]?.title || doc.topic;
                    const pathInfo = doc.path && doc.path !== doc.filename ? ` [路径: ${doc.path}]` : '';
                    docLink.title = `${doc.author || '未知作者'} - ${doc.description || doc.title} [${categoryTitle} - ${topicTitle}]${pathInfo}`;

                    docItem.appendChild(docLink);
                    allDocsList.appendChild(docItem);
                });
            }

            allDocsItem.appendChild(allDocsList);
            categorySidebar.appendChild(allDocsItem);

            // 为"所有文档"标题添加点击事件
            allDocsHeader.addEventListener('click', function () {
                toggleAllDocs(allDocsHeader, allDocsList);
            });

            // 为"所有文档"标题的按钮添加点击事件
            allDocsToggleBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                toggleAllDocs(allDocsHeader, allDocsList);
            });

            // 恢复"所有文档"的展开/收起状态
            const isAllDocsCollapsed = getCollapsedState('all-docs', 'all-docs');
            if (isAllDocsCollapsed) {
                allDocsList.classList.add('collapsed');
                allDocsToggleBtn.classList.add('collapsed');
                // allDocsToggleBtn.innerHTML = '▶';
            } else {
                allDocsToggleBtn.innerHTML = '▼';
            }
        }

        // 展开/收起分类
        function toggleCategory(categoryKey, categoryHeader, topicList) {
            const isCollapsed = topicList.classList.contains('collapsed');
            const toggleBtn = categoryHeader.querySelector('.category-toggle');

            if (isCollapsed) {
                // 展开
                topicList.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.innerHTML = '▼';
                setCollapsedState('category', categoryKey, false);
            } else {
                // 收起
                topicList.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                // toggleBtn.innerHTML = '▶';
                setCollapsedState('category', categoryKey, true);
            }
        }

        // 展开/收起主题
        function toggleTopic(categoryKey, topicKey, topicHeader, fileList) {
            const isCollapsed = fileList.classList.contains('collapsed');
            const toggleBtnArray = topicHeader.querySelectorAll('.topic-toggle');

            for (let i = 0; i < toggleBtnArray.length; i++) {
                const toggleBtn = toggleBtnArray[i];
                if (isCollapsed) {
                    // 展开
                    fileList.classList.remove('collapsed');
                    toggleBtn.classList.remove('collapsed');
                    toggleBtn.innerHTML = '▼';  // 添加这行
                    setCollapsedState('topic', `${categoryKey}-${topicKey}`, false);
                } else {
                    // 收起
                    fileList.classList.add('collapsed');
                    toggleBtn.classList.add('collapsed');
                    // toggleBtn.innerHTML = '▶';  // 添加这行
                    setCollapsedState('topic', `${categoryKey}-${topicKey}`, true);
                }
            }
        }

        // 展开/收起"所有文档"
        function toggleAllDocs(allDocsHeader, allDocsList) {
            const isCollapsed = allDocsList.classList.contains('collapsed');
            const toggleBtn = allDocsHeader.querySelector('.category-toggle');

            if (isCollapsed) {
                // 展开
                allDocsList.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.innerHTML = '▼';  // 添加这行
                setCollapsedState('all-docs', 'all-docs', false);
            } else {
                // 收起
                allDocsList.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                // toggleBtn.innerHTML = '▶';  // 添加这行
                setCollapsedState('all-docs', 'all-docs', true);
            }
        }



        // 从localStorage获取展开/收起状态
        function getCollapsedState(type, key) {
            try {
                const storageKey = `docsViewerSidebar${type.charAt(0).toUpperCase() + type.slice(1)}${key.charAt(0).toUpperCase() + key.slice(1)}`;
                const state = localStorage.getItem(storageKey);
                return state === 'true';
            } catch (error) {
                console.warn('无法从localStorage获取展开/收起状态:', error);
                return false;
            }
        }

        // 保存展开/收起状态到localStorage
        function setCollapsedState(type, key, isCollapsed) {
            try {
                const storageKey = `docsViewerSidebar${type.charAt(0).toUpperCase() + type.slice(1)}${key.charAt(0).toUpperCase() + key.slice(1)}`;
                localStorage.setItem(storageKey, isCollapsed.toString());
            } catch (error) {
                console.warn('无法保存展开/收起状态到localStorage:', error);
            }
        }

        // 初始化下拉菜单
        function initializeDropdownMenu() {
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownMenu = document.querySelector('.dropdown-menu');

            if (!dropdownToggle || !dropdownMenu) return;

            // 点击切换下拉菜单
            dropdownToggle.addEventListener('click', function (e) {
                e.preventDefault();
                dropdownMenu.classList.toggle('show');
            });

            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', function (e) {
                if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
        }

        // 更新当前分类的文档列表
        function updateCurrentCategoryDocs(filePath) {
            const currentCategoryTitle = document.getElementById('current-category-title');
            const currentCategoryDocs = document.getElementById('current-category-docs');

            if (!currentCategoryTitle || !currentCategoryDocs) return;

            // 等待配置加载完成
            if (!DOC_CONFIG || !ALL_DOCS || ALL_DOCS.length === 0) {
                console.warn('文档配置尚未加载，稍后重试');
                setTimeout(() => updateCurrentCategoryDocs(filePath), 100);
                return;
            }

            // 查找当前文档信息
            const currentDoc = ALL_DOCS.find(doc => doc.filename === filePath);

            if (!currentDoc) {
                // 如果找不到文档，显示所有文档
                currentCategoryTitle.textContent = '所有文档';
                currentCategoryDocs.innerHTML = '';

                // 按分类和排序组织文档
                const sortedDocs = [...ALL_DOCS].sort((a, b) => {
                    // 先按分类排序
                    const categoryOrderA = MAIN_CATEGORIES[a.category]?.order || 999;
                    const categoryOrderB = MAIN_CATEGORIES[b.category]?.order || 999;
                    if (categoryOrderA !== categoryOrderB) {
                        return categoryOrderA - categoryOrderB;
                    }
                    // 同一分类内按排序值排序
                    return (a.order || 999) - (b.order || 999);
                });

                sortedDocs.forEach(doc => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `?file=${doc.filename}`;
                    link.textContent = doc.title;
                    link.title = `${doc.author || '未知作者'} - ${doc.description || doc.title}`;

                    if (doc.filename === filePath) {
                        link.classList.add('active');
                    }

                    li.appendChild(link);
                    currentCategoryDocs.appendChild(li);
                });

                return;
            }

            // 显示当前文档的分类信息
            const category = MAIN_CATEGORIES[currentDoc.category];
            const topic = DOC_CONFIG.topics ? DOC_CONFIG.topics[currentDoc.topic] : null;

            let titleText = category ? category.title : currentDoc.category;
            if (topic) {
                titleText += ` - ${topic.title}`;
            }

            currentCategoryTitle.textContent = titleText;

            // 清空现有列表
            currentCategoryDocs.innerHTML = '';

            // 显示同一分类和主题下的其他文档
            const relatedDocs = ALL_DOCS.filter(doc =>
                doc.category === currentDoc.category && doc.topic === currentDoc.topic
            ).sort((a, b) => (a.order || 999) - (b.order || 999));

            if (relatedDocs.length > 0) {
                relatedDocs.forEach(doc => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `?file=${doc.filename}`;
                    link.textContent = doc.title;
                    link.title = `${doc.author || '未知作者'} - ${doc.description || doc.title}`;

                    if (doc.filename === filePath) {
                        link.classList.add('active');
                    }

                    li.appendChild(link);
                    currentCategoryDocs.appendChild(li);
                });
            } else {
                // 如果没有相关文档，显示同一分类下的所有文档
                const categoryDocs = ALL_DOCS.filter(doc =>
                    doc.category === currentDoc.category
                ).sort((a, b) => (a.order || 999) - (b.order || 999));

                categoryDocs.forEach(doc => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `?file=${doc.filename}`;
                    link.textContent = doc.title;
                    link.title = `${doc.author || '未知作者'} - ${doc.description || doc.title}`;

                    if (doc.filename === filePath) {
                        link.classList.add('active');
                    }

                    li.appendChild(link);
                    currentCategoryDocs.appendChild(li);
                });
            }
        }

        // 初始化手机端导航
        function initializeMobileNavigation() {
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
            const mobileNavClose = document.getElementById('mobile-nav-close');
            const mobileNavBack = document.getElementById('mobile-nav-back');
            const mobileNavSections = document.getElementById('mobile-nav-sections');

            // 检查是否为移动设备
            function isMobileDevice() {
                return window.innerWidth <= 768;
            }

            // 设置初始显示状态
            updateMobileNavVisibility();

            // 确保在移动设备上也能正常工作
            if (isMobileDevice()) {
                console.log('检测到移动设备，初始化手机端导航');
            }

            // 生成手机端导航内容
            function generateMobileNavContent() {
                if (!DOC_CONFIG || ALL_DOCS.length === 0) {
                    console.warn('文档配置尚未加载，稍后重试');
                    setTimeout(generateMobileNavContent, 100);
                    return;
                }

                mobileNavSections.innerHTML = '';

                // 添加分割线
                const divider = document.createElement('div');
                divider.className = 'mobile-nav-divider';
                mobileNavSections.appendChild(divider);

                // 生成分类导航
                Object.keys(MAIN_CATEGORIES).forEach(categoryKey => {
                    const category = MAIN_CATEGORIES[categoryKey];

                    // 检查该分类是否有文档，如果没有则跳过
                    if (!categoryHasDocuments(categoryKey)) {
                        return; // 跳过空分类
                    }

                    // 创建分类容器
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'mobile-category';

                    // 创建分类标题（可点击展开/收起）
                    const categoryTitle = document.createElement('div');
                    categoryTitle.className = 'mobile-category-title';
                    categoryTitle.textContent = category.title;

                    // 添加展开/收起按钮
                    const categoryToggleBtn = document.createElement('button');
                    categoryToggleBtn.className = 'mobile-category-toggle';
                    categoryToggleBtn.setAttribute('aria-label', '展开/收起分类');
                    categoryToggleBtn.innerHTML = '▼';
                    categoryTitle.appendChild(categoryToggleBtn);

                    // 为分类标题添加点击事件
                    categoryTitle.addEventListener('click', function (e) {
                        // 如果点击的是按钮，让按钮处理
                        if (e.target === categoryToggleBtn) return;
                        toggleMobileCategory(categoryKey, categoryDiv, categoryToggleBtn);
                    });

                    // 为按钮添加点击事件
                    categoryToggleBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        toggleMobileCategory(categoryKey, categoryDiv, categoryToggleBtn);
                    });

                    categoryDiv.appendChild(categoryTitle);

                    // 获取该分类下的所有主题
                    const categoryTopics = DOC_CONFIG.categories[categoryKey]?.topics || {};

                    if (Object.keys(categoryTopics).length > 0) {
                        Object.keys(categoryTopics).forEach(topicKey => {
                            const topic = categoryTopics[topicKey];

                            // 检查主题是否有文档，如果没有则跳过
                            if (!topic.files || topic.files.length === 0) {
                                return; // 跳过空主题
                            }

                            // 创建主题容器
                            const topicDiv = document.createElement('div');
                            topicDiv.className = 'mobile-topic';

                            // 创建主题标题（可点击展开/收起）
                            const topicTitle = document.createElement('div');
                            topicTitle.className = 'mobile-topic-title';
                            topicTitle.textContent = topic.title;

                            // 添加展开/收起按钮
                            const topicToggleBtn = document.createElement('button');
                            topicToggleBtn.className = 'mobile-topic-toggle';
                            topicToggleBtn.setAttribute('aria-label', '展开/收起主题');
                            topicToggleBtn.innerHTML = '▼';
                            topicTitle.appendChild(topicToggleBtn);

                            // 为主题标题添加点击事件
                            topicTitle.addEventListener('click', function (e) {
                                // 如果点击的是按钮，让按钮处理
                                if (e.target === topicToggleBtn) return;
                                toggleMobileTopic(categoryKey, topicKey, topicDiv, topicToggleBtn);
                            });

                            // 为按钮添加点击事件
                            topicToggleBtn.addEventListener('click', function (e) {
                                e.stopPropagation();
                                toggleMobileTopic(categoryKey, topicKey, topicDiv, topicToggleBtn);
                            });

                            topicDiv.appendChild(topicTitle);

                            // 创建文档列表
                            const fileList = document.createElement('ul');
                            fileList.className = 'mobile-file-list';

                            topic.files.forEach(file => {
                                const fileItem = document.createElement('li');
                                fileItem.className = 'mobile-file-item';

                                const fileLink = document.createElement('a');
                                fileLink.href = `?file=${file.filename}`;
                                fileLink.className = 'mobile-file-link';
                                fileLink.textContent = file.title;
                                fileLink.title = file.description || file.title;

                                // 检查是否为当前文档
                                const currentUrl = new URL(window.location);
                                const currentFile = currentUrl.searchParams.get('file') || 'test.md';
                                if (file.filename === currentFile) {
                                    fileLink.classList.add('active');
                                }

                                // 添加点击事件，点击后关闭导航
                                fileLink.addEventListener('click', function () {
                                    closeMobileNav();
                                });

                                fileItem.appendChild(fileLink);
                                fileList.appendChild(fileItem);
                            });

                            topicDiv.appendChild(fileList);
                            categoryDiv.appendChild(topicDiv);

                            // 恢复主题的展开/收起状态
                            const isTopicCollapsed = getMobileCollapsedState('topic', `${categoryKey}-${topicKey}`);
                            if (isTopicCollapsed) {
                                topicDiv.classList.add('collapsed');
                                topicToggleBtn.classList.add('collapsed');
                                // topicToggleBtn.innerHTML = '▶';
                            }
                        });
                    }

                    mobileNavSections.appendChild(categoryDiv);

                    // 恢复分类的展开/收起状态
                    const isCategoryCollapsed = getMobileCollapsedState('category', categoryKey);
                    if (isCategoryCollapsed) {
                        categoryDiv.classList.add('collapsed');
                        const categoryToggleBtn = categoryDiv.querySelector('.mobile-category-toggle');
                        if (categoryToggleBtn) {
                            categoryToggleBtn.classList.add('collapsed');
                            // categoryToggleBtn.innerHTML = '▶';
                        }
                    }
                });

                // 添加分割线
                const allDocsDivider = document.createElement('div');
                allDocsDivider.className = 'mobile-nav-divider';
                mobileNavSections.appendChild(allDocsDivider);

                // 添加"所有文档"部分
                const allDocsDiv = document.createElement('div');
                allDocsDiv.className = 'mobile-category all-docs';

                const allDocsTitle = document.createElement('div');
                allDocsTitle.className = 'mobile-category-title';
                allDocsTitle.textContent = '所有文档';

                // 添加展开/收起按钮
                const allDocsToggleBtn = document.createElement('button');
                allDocsToggleBtn.className = 'mobile-category-toggle';
                allDocsToggleBtn.setAttribute('aria-label', '展开/收起所有文档');
                allDocsToggleBtn.innerHTML = '▼';
                allDocsTitle.appendChild(allDocsToggleBtn);

                // 为"所有文档"标题添加点击事件
                allDocsTitle.addEventListener('click', function (e) {
                    // 如果点击的是按钮，让按钮处理
                    if (e.target === allDocsToggleBtn) return;
                    toggleMobileAllDocs(allDocsDiv, allDocsToggleBtn);
                });

                // 为按钮添加点击事件
                allDocsToggleBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleMobileAllDocs(allDocsDiv, allDocsToggleBtn);
                });

                allDocsDiv.appendChild(allDocsTitle);

                const allDocsList = document.createElement('ul');
                allDocsList.className = 'mobile-file-list';

                // 确保ALL_DOCS存在且是数组
                const allDocs = ALL_DOCS || [];
                if (allDocs.length === 0) {
                    // 如果没有文档，显示提示信息
                    const noDocsItem = document.createElement('li');
                    noDocsItem.className = 'mobile-file-item';
                    noDocsItem.textContent = '未找到任何文档';
                    allDocsList.appendChild(noDocsItem);
                } else {
                    // 按分类和排序组织文档
                    const sortedDocs = [...allDocs].sort((a, b) => {
                        // 先按分类排序
                        const categoryOrderA = MAIN_CATEGORIES[a.category]?.order || 999;
                        const categoryOrderB = MAIN_CATEGORIES[b.category]?.order || 999;
                        if (categoryOrderA !== categoryOrderB) {
                            return categoryOrderA - categoryOrderB;
                        }
                        // 同一分类内按排序值排序
                        return (a.order || 999) - (b.order || 999);
                    });

                    sortedDocs.forEach(doc => {
                        const docItem = document.createElement('li');
                        docItem.className = 'mobile-file-item';

                        const docLink = document.createElement('a');
                        docLink.href = `?file=${doc.path || doc.filename}`;
                        docLink.className = 'mobile-file-link';
                        docLink.textContent = doc.title;

                        // 添加更详细的标题信息
                        const categoryTitle = MAIN_CATEGORIES[doc.category]?.title || doc.category;
                        const topicTitle = DOC_CONFIG.topics && DOC_CONFIG.topics[doc.topic] ? DOC_CONFIG.topics[doc.topic].title : doc.topic;
                        const pathInfo = doc.path && doc.path !== doc.filename ? ` [路径: ${doc.path}]` : '';
                        docLink.title = `${doc.author || '未知作者'} - ${doc.description || doc.title} [${categoryTitle} - ${topicTitle}]${pathInfo}`;

                        // 检查是否为当前文档
                        const currentUrl = new URL(window.location);
                        const currentFile = currentUrl.searchParams.get('file') || 'test.md';
                        if (doc.filename === currentFile) {
                            docLink.classList.add('active');
                        }

                        // 添加点击事件，点击后关闭导航
                        docLink.addEventListener('click', function () {
                            closeMobileNav();
                        });

                        docItem.appendChild(docLink);
                        allDocsList.appendChild(docItem);
                    });
                }

                allDocsDiv.appendChild(allDocsList);
                mobileNavSections.appendChild(allDocsDiv);
            }

            // 打开手机端导航
            function openMobileNav() {
                mobileNavOverlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // 防止背景滚动
                generateMobileNavContent();
            }

            // 关闭手机端导航
            function closeMobileNav() {
                mobileNavOverlay.classList.remove('active');
                document.body.style.overflow = ''; // 恢复滚动
            }

            // 绑定事件监听器
            mobileNavToggle.addEventListener('click', openMobileNav);
            mobileNavClose.addEventListener('click', closeMobileNav);
            mobileNavBack.addEventListener('click', closeMobileNav);

            // 点击覆盖层背景关闭导航（除了返回区域）
            mobileNavOverlay.addEventListener('click', function (e) {
                if (e.target === mobileNavOverlay) {
                    closeMobileNav();
                }
            });

            // 更新手机端导航可见性
            function updateMobileNavVisibility() {
                if (isMobileDevice()) {
                    mobileNavToggle.style.display = 'flex';
                } else {
                    mobileNavToggle.style.display = 'none';
                    closeMobileNav(); // 在非移动设备上关闭导航
                }
            }

            // 监听窗口大小变化
            window.addEventListener('resize', updateMobileNavVisibility);
        }

        // 移动端分类展开/收起功能
        function toggleMobileCategory(categoryKey, categoryDiv, toggleBtn) {
            const isCollapsed = categoryDiv.classList.contains('collapsed');

            if (isCollapsed) {
                // 展开
                categoryDiv.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.innerHTML = '▼';
                setMobileCollapsedState('category', categoryKey, false);
            } else {
                // 收起
                categoryDiv.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                // toggleBtn.innerHTML = '▶';
                setMobileCollapsedState('category', categoryKey, true);
            }
        }

        // 移动端主题展开/收起功能
        function toggleMobileTopic(categoryKey, topicKey, topicDiv, toggleBtn) {
            const isCollapsed = topicDiv.classList.contains('collapsed');

            if (isCollapsed) {
                // 展开
                topicDiv.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.innerHTML = '▼';
                setMobileCollapsedState('topic', `${categoryKey}-${topicKey}`, false);
            } else {
                // 收起
                topicDiv.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                // toggleBtn.innerHTML = '▶';
                setMobileCollapsedState('topic', `${categoryKey}-${topicKey}`, true);
            }
        }

        // 移动端"所有文档"展开/收起功能
        function toggleMobileAllDocs(allDocsDiv, toggleBtn) {
            const isCollapsed = allDocsDiv.classList.contains('collapsed');

            if (isCollapsed) {
                // 展开
                allDocsDiv.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.innerHTML = '▼';
                setMobileCollapsedState('all-docs', 'all-docs', false);
            } else {
                // 收起
                allDocsDiv.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                // toggleBtn.innerHTML = '▶';
                setMobileCollapsedState('all-docs', 'all-docs', true);
            }
        }

        // 从localStorage获取移动端展开/收起状态
        function getMobileCollapsedState(type, key) {
            try {
                const storageKey = `mobileNav${type.charAt(0).toUpperCase() + type.slice(1)}${key.charAt(0).toUpperCase() + key.slice(1)}`;
                const state = localStorage.getItem(storageKey);
                return state === 'true';
            } catch (error) {
                console.warn('无法从localStorage获取移动端展开/收起状态:', error);
                return false;
            }
        }

        // 保存移动端展开/收起状态到localStorage
        function setMobileCollapsedState(type, key, isCollapsed) {
            try {
                const storageKey = `mobileNav${type.charAt(0).toUpperCase() + type.slice(1)}${key.charAt(0).toUpperCase() + key.slice(1)}`;
                localStorage.setItem(storageKey, isCollapsed.toString());
            } catch (error) {
                console.warn('无法保存移动端展开/收起状态到localStorage:', error);
            }
        }

        // 初始化侧边栏滚动功能
        function initializeSidebarScrolling() {
            const sidebar = document.querySelector('.sidebar');
            if (!sidebar) return;

            let isScrolling = false;
            let scrollTimeout;

            // 滚动事件处理
            sidebar.addEventListener('scroll', function () {
                if (!isScrolling) {
                    sidebar.classList.add('scrolling');
                    isScrolling = true;
                }

                // 清除之前的超时
                clearTimeout(scrollTimeout);

                // 设置新的超时，在停止滚动后移除类
                scrollTimeout = setTimeout(function () {
                    sidebar.classList.remove('scrolling');
                    isScrolling = false;
                }, 150);
            });

            // 为侧边栏内的链接添加平滑滚动效果
            const sidebarLinks = sidebar.querySelectorAll('a[href^="#"]');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);

                    if (targetElement) {
                        // 计算滚动位置，考虑固定头部高度
                        const headerHeight = document.querySelector('.site-header').offsetHeight;
                        const targetPosition = targetElement.offsetTop - headerHeight - 20;

                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });

            // 添加键盘导航支持
            sidebar.addEventListener('keydown', function (e) {
                // 上下箭头键滚动
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    sidebar.scrollTop -= 30;
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    sidebar.scrollTop += 30;
                }
                // Home键滚动到顶部
                else if (e.key === 'Home') {
                    e.preventDefault();
                    sidebar.scrollTop = 0;
                }
                // End键滚动到底部
                else if (e.key === 'End') {
                    e.preventDefault();
                    sidebar.scrollTop = sidebar.scrollHeight;
                }
            });

            // 确保侧边栏可以获得焦点以支持键盘导航
            sidebar.setAttribute('tabindex', '0');

            // 添加滚动指示器（可选）
            addScrollIndicator(sidebar);
        }

        // 添加滚动指示器
        function addScrollIndicator(sidebar) {
            // 检查是否需要滚动指示器
            function checkScrollNeeded() {
                const needsScroll = sidebar.scrollHeight > sidebar.clientHeight;

                // 如果需要滚动且没有指示器，则添加一个
                if (needsScroll && !sidebar.querySelector('.scroll-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'scroll-indicator';
                    indicator.innerHTML = '↓';
                    indicator.style.cssText = `
                        position: absolute;
                        bottom: 10px;
                        right: 10px;
                        background: rgba(0, 123, 255, 0.7);
                        color: white;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        opacity: 0.7;
                        pointer-events: none;
                        transition: opacity 0.3s ease;
                        z-index: 10;
                    `;

                    // 将指示器添加到侧边栏内容区域
                    const sidebarContent = sidebar.querySelector('.sidebar-content');
                    if (sidebarContent) {
                        sidebarContent.style.position = 'relative';
                        sidebarContent.appendChild(indicator);

                        // 监听滚动，当用户开始滚动时隐藏指示器
                        let hideTimeout;
                        sidebar.addEventListener('scroll', function () {
                            indicator.style.opacity = '0';

                            // 清除之前的超时
                            clearTimeout(hideTimeout);

                            // 如果滚动到顶部，重新显示指示器
                            if (sidebar.scrollTop <= 10) {
                                hideTimeout = setTimeout(() => {
                                    indicator.style.opacity = '0.7';
                                }, 1000);
                            }
                        });
                    }
                }
                // 如果不需要滚动且有指示器，则移除它
                else if (!needsScroll) {
                    const indicator = sidebar.querySelector('.scroll-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            }

            // 初始检查
            checkScrollNeeded();

            // 窗口大小变化时重新检查
            window.addEventListener('resize', checkScrollNeeded);

            // 内容变化时重新检查（使用MutationObserver）
            const observer = new MutationObserver(checkScrollNeeded);
            observer.observe(sidebar, { childList: true, subtree: true });
        }
    </script>
</body>

</html>